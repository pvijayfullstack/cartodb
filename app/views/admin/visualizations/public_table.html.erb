<%= content_for(:page_title) do %><%= @table.name.gsub(/_/," ") %><% end %>

<%= content_for(:description) do %><%= @table.description ? "#{@table.description}. Map created by #{@name} in CartoDB" : "Map created by #{@name} in CartoDB" %><% end %>

<%= content_for(:twitter_card) do %><%= Carto::StaticMapsURLHelper.new.url_for_static_map(request, @table.table_visualization, 560, 300) %><% end %>
<%= content_for(:facebook_card) do %><%= Carto::StaticMapsURLHelper.new.url_for_static_map(request, @table.table_visualization, 1200, 630) %><% end %>

<%= content_for(:css) do %>
  <%= stylesheet_link_tag 'cartodb', 'common', 'public_map' %>
<% end %>

<% content_for(:js) do %>
  <% if @table.map.provider == 'googlemaps' %>
    <script type="text/javascript"
      src="//maps.googleapis.com/maps/api/js?sensor=false&v=3.12&<%= @user.google_maps_query_string %>">
    </script>
  <% end %>

  <%= javascript_include_tag 'cdb.js', 'templates.js', 'public_map_deps' %>

  <script>
    var table_name          = '<%=raw @table.owner.sql_safe_database_schema %>.<%= @table.name %>';
    var table_id            = '<%= @table.id %>';
    var schema              = <%= safe_js_object @table.schema.to_json %>;
    var user_name           = '<%= @user.username %>';
    var owner_username      = '<%= @table.owner.username %>';
    var belong_organization = <%= @table.owner.has_organization? %>;
    var map                 = <%= safe_js_object @table.map.to_json %>;
    var config              = <%= safe_js_object frontend_config_public({https_apis: request.protocol == 'https://' }) %>;
    var vizjson             = <%= safe_js_object @vizjson.to_json %>;
    var auth_token          = <%= safe_js_object @auth_tokens.to_json %>;
    var use_https           = <%= @use_https =%>;
    var api_key             = <%= safe_js_object @api_key.to_json %>;
    var base_url            = '<%= @table.owner.public_url(nil, request.protocol == "https://" ? "https" : "http") %>';

    var debug = false;
    <% if Rails.env.development? || Cartodb.config[:no_cdn] == true %>
      debug = true;
    <% end %>

    cdb.config.set('debug', debug);

    $(function() {
      <% if Cartodb.config[:graphite_public] %>
        if (location.protocol.indexOf('https') === -1) {
          jQuery.getScript('<%= javascript_path "statsc.js" %>', function(ready) {
            statsc.connect('http://<%= Cartodb.config[:graphite_public]['host'] %>:<%= Cartodb.config[:graphite_public]['port'] %>/');
              cartodb.core.Profiler.backend(function () {
              statsc.send.apply(statsc, arguments);
            })
            // stop sending stats after 11 seconds
            // statsc send stats in 5 secs interval so allow to send at least twice
            setTimeout(function() {
                cartodb.core.Profiler.backend(null);
            }, 11*1000);

          })
        }
      <% end %>
    });
  </script>
  
<% end %>

<%= content_for(:content) do %>
  <%= render 'admin/shared/public_header' %>

  <div class="PublicMap-map js-map" id="map">
    <div class="Spinner Spinner--center"></div>
  </div>

  <%# Legacy from current embed %>
  <div class="NotSupportedDialog" id="not_supported_dialog" style="display: none">
    <h2 class="NotSupportedDialog-title">CartoDB</h2>
    <p class="NotSupportedDialog-desc">This visualization only works in modern browsers. Upgrade yours and enjoy.</p>
    <ul class="NotSupportedDialog-list">
      <li class="NotSupportedDialog-item"><a class="NotSupportedDialog-itemLink NotSupportedDialog-itemLink--Safari" href="http://www.apple.com/safari/" class="safari">Safari</a></li>
      <li class="NotSupportedDialog-item"><a class="NotSupportedDialog-itemLink NotSupportedDialog-itemLink--Chrome" href="https://www.google.com/chrome/" class="chrome">Chrome</a></li>
      <li class="NotSupportedDialog-item is-last"><a class="NotSupportedDialog-itemLink NotSupportedDialog-itemLink--Firefox" href="http://www.mozilla.org/en-US/firefox/all/â€Ž" class="firefox">Firefox</a></li>
    </ul>
  </div>

  <div class="Navmenu js-Navmenu">
    <div class="u-inner">
      <div class="PublicMap-block">
        <div class="PublicMap-gradient"></div>

        <div class="PublicMap-leftBlock PublicMap-leftBlock--owner">
          <ul class="Navmenu-list Navmenu-list--owner Navmenu-list--avatar">
            <li class="Navmenu-item">
              <a href="<%= CartoDB.url(self, 'root', {}, @visualization.user) %>" target="_blank" class="UserAvatar">
                <img class="UserAvatar-img--medium" src="<%= @visualization.user.avatar %>" alt="<%= @name %>" title="<%= @name %>" />
              </a>
            </li>
          </ul>

          <ul class="Navmenu-list Navmenu-list--owner">
            <li class="Navmenu-item last-child">
              <a href="<%= CartoDB.url(self, 'root', {}, @visualization.user) %>" class="Navmenu-link Navmenu-link--owner"><%= @name %></a>
            </li>

            <li class="Navmenu-item u-hideOnTablet">
              <i class="Navmenu-rarrow iconFont iconFont-Rarrow"></i>
              <a href="<%= CartoDB.url(self, 'public_datasets_home', {}, @visualization.user) %>" class="Navmenu-link">Datasets</a>
            </li>
          </ul>
        </div>

        <div class="PublicMap-rightBlock PublicMap-rightBlock--owner u-txt-right">
          <ul class="Navmenu-list">
            <li class="Navmenu-item Navmenu-item--action u-hideOnTablet">
              <i class="Navmenu-actionIcon iconFont iconFont-Markup"></i>
              <a href="#" class="Navmenu-link Navmenu-link--action">API call</a>
            </li>

            <li class="Navmenu-item Navmenu-item--action u-hideOnTablet">
              <i class="Navmenu-actionIcon iconFont iconFont-Floppy"></i>
              <a href="#" class="Navmenu-link Navmenu-link--action">Download</a>
            </li>

            <% if !Cartodb.config[:cartodb_com_hosted].present? %>
              <li class="Navmenu-item">
                <a class="Button Button--main Navmenu-editLink Navmenu-editLink--create is-active" href="http://oneclick.cartodb.com/?file=<%= CGI.escape( @export_sql_api_url ) %>&provider=<%= URI.encode(@table.owner.username) %>&logo=<%= URI.encode(@avatar_url) %>">Create map</a>
              </li>
            <% end %>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <div class="PublicMap-secondary">
    <div class="u-inner">
      <div class="PublicMap-block">
        <div class="PublicMap-leftBlock PublicMap-leftBlock--large">
          <div class="js-user-meta">
            <h1 class="PublicMap-title js-PublicMap-title Title Title--m"><%= @visualization.name %></h1>
            <% if @visualization.description_clean %>
              <div class="PublicMap-description"><%= raw @visualization.description_html_safe %></div>
            <% end %>

            <div class="PublicMap-meta">
              <% if @visualization.tags.size > 0 %>
                <ul class="PublicMap-metaList">
                  <li class="PublicMap-metaItem">
                    <i class="PublicMap-metaIcon iconFont iconFont-Label"></i>
                    <%# Keep on one line to avoid unwanted spaces %>
                    <% formatted_tags(@visualization.tags) do |tag| %><a class="PublicMap-metaLink" href="<%= CartoDB.url(self, 'public_tag', {tag: tag}, @visualization.user) %>"><%= tag %></a><% end %>
                  </li>
                </ul>
              <% end %>

              <ul class="PublicMap-metaList PublicMap-metaList--mobile js-PublicMap-metaList--mobile">
                <li class="PublicMap-metaItem"><i class="PublicMap-metaIcon iconFont iconFont-Calendar"></i> <%= time_ago_in_words(@visualization.updated_at) %> ago</li>
                <li class="PublicMap-metaItem"><i class="PublicMap-metaIcon iconFont iconFont-Stats"></i> <%= number_with_delimiter(@mapviews) %> <%= 'mapview'.pluralize(@mapviews) %></li>
              </ul>
            </div>

            <a class="Navmenu-editLink Navmenu-editLink--more js-Navmenu-editLink--more" href="#/more">More info</a>
          </div>
        </div>
      </div>
    </div>

    <%# DISQUS %>
    <div class="u-inner">
      <div class="PublicMap-block PublicMap-info">
        <div class="PublicMap-leftBlock PublicMap-leftBlock--large">
          <div id="disqus_thread"></div>
          <script type="text/javascript">
            var disqus_shortname  = '<%= @disqus_shortname %>';
            var disqus_identifier = '<%= @visualization.id %>';

            (function() {
              var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
              dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
              (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
          </script>
        </div>
      </div>
    </div>
  </div>

  <% if cartodb_com_hosted? %>
    <%= render 'admin/shared/footer', :light => true %>
  <% else %>
    <%= render 'admin/shared/public_footer', :light => false %>
  <% end %>
<% end %>


  <!--div class="globalerror"></div>
  <div class="panes"></div>

  <div class="navigation">
    <ul>
      <li><%= link_to "Table view", "#/table", :class => 'smaller strong tab selected' %></li>
      <li><%= link_to "Map view", "#/map"%></li>
    </ul>
  </div>

  <div class="separator_shadow"></div>
  <div class="separator bottom"></div>

            <h2>Maps using this data</h2>
            <ul>

              <% if @total_visualizations.count == 0 && @total_nonpublic_total_vis_count == 0 %>
                <li class="private">This dataset is not used in any map</li>
              <% end %>

              <% @total_visualizations.each do |vis| %>
                <% if vis.privacy == "public" %>
                  <li>
                    <a href="<%= CartoDB.url(self, 'public_visualizations_public_map', {id: vis.id}, @table.owner) %>" title="<%= vis.name.gsub(/_/," ") %>"><%= vis.name.gsub(/_/, " ") %></a>
                  </li>
                <% end %>
              <% end %>

              <% if @total_nonpublic_total_vis_count > 0 %>

                <li class="private">
                  <%= @total_nonpublic_total_vis_count %> private map<%= @total_nonpublic_total_vis_count != 1 ? 's' : '' %><span class="help" original-title="This dataset is used in <%= @total_nonpublic_total_vis_count %> map<%= @total_nonpublic_total_vis_count != 1 ? 's' : '' %> made private by the publisher">(?)</span>
                </li>
              <% end %>
            </ul>
