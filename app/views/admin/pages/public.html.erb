<% content_for(:page_title) do %>
  <%#= current_user.username %> |
<% end %>

<%= content_for(:js) do %>

  <script type="text/javascript" src="//maps.google.com/maps/api/js?sensor=false&v=3.12"></script>

  <%= javascript_include_tag :cdb, :application %>
  <!--[if lt IE 9]>
  <%= javascript_include_tag :"respond" %>
  <script>
    document.createElement('header');
    document.createElement('nav');
    document.createElement('footer');
  </script>
  <![endif]-->

  <script type="text/javascript">

    $(function() {

      var url = "//" + window.location.host  + "/api/v1/get_authenticated_users";

      $.getJSON(url, {},
        function(users, status, response) {

          if (response.status == 200 && users && users.length > 0) {

            url = "http://" + users[0] + ".cartodb.com/login";

            var $dashboard = $("li.dashboard");

            $dashboard.find("a").text("Welcome, " + users[0]);
            $dashboard.find("a").attr("href", url);
            $dashboard.find("a").attr("title", "Welcome, " + users[0]);
            $dashboard.removeClass("hide");

            var $signin = $("a.signin");

            url = "http://" + users[0] + ".cartodb.com/logout";

            $signin.text("Logout");
            $signin.attr("href", url);
            $signin.attr("title", "Logout");

          }

        }
      );

      });
  </script>

<% end %>

<%= content_for(:css) do %>
  <%= stylesheet_link_tag :common, :dashboard, :public %>
  <link rel="stylesheet" href="//cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/themes/css/cartodb.css" />
  <!--[if lte IE 8]>
  <%= stylesheet_link_tag :public_ie %>
  <![endif]-->
<% end %>

<div class="content">

  <div class="inner">

  <div class="info">

    <div class="user-info">

      <a href="/" class="avatar">
        <div class="circle">
          <img src="<%= @avatar_url %>" />
        </div>
      </a>

      <div class="username">
        <h2><%= @username %></h2>
      </div>

      <ul>
        <li><a href="/datasets" class="count"><strong><%= @tables_num %></strong>dataset<%= @tables_num == 1 ? '' : 's' %></a></li>
        <li><div class="count"><strong><%= @vis_num %></strong>visualization<%= @vis_num == 1 ? '' : 's' %></div></li>
      </ul>

    </div>

    <% if @tags.size > 0 %>
      <ul class="tags">
        <li><strong>Browse by tag</strong></li>

        <% @tags.each_with_index do |tag, i| %>
          <li<%= " class='#{i == 0 ? "first" : "last" }'" if i == 0 || i == @tags.size - 1 %>>
            <% if params[:tag] && params[:tag] == tag %>
            <%= tag.capitalize.truncate(40) %>
              <% else %>
            <%= link_to tag.capitalize.truncate(40), public_tag_url(tag) %>
        <% end %>
        <% end %>

      </ul>
    <% end %>

  </div>

  <div class="visualizations">
    <% if @visualizations.size == 0 %>
      <div class="empty">
        <%= @username %> doesn't have any public map
      </div>
    <% end %>

    <% if @visualizations.size > 0 %>
      <ul>
        <% @visualizations.each_with_index do |vis, i| %>
          <li>
            <div class="map-wrapper<%= " headless" if vis[:tags].size == 0 %>">

              <a href="/viz/<%= vis[:id] %>/public_map" class="backdrop"></a>
              <div id="map_<%= i %>" class="map"></div>

              <div class="title">
                <h3><%= vis[:title].truncate(50) %></h3>
                <p><%= raw (vis[:description] ? vis[:description].truncate(200) : "") %></p>
              </div>
              <div class="gradient"></div>
            </div>

            <% if vis[:tags].size > 0 %>
            <div class="header">
              <% if vis[:tags].size > 0 %>
                <ul class="tags">
                  <% vis[:tags].each do |tag| %>
                    <li><%= link_to tag, public_tag_url(tag) %></li>
                  <% end %>
                </ul>
              <% end %>
              <div class="mapviews"><%= vis[:mapviews] %> Map views</div>
            </div>
            <% end %>
          </li>
        <% end %>
      </ul>
    <% end %>

    <% if @visualizations.length > 0 %>
      <div class="pagination">
        <% if @pages > 1 %>

          <% if @pages > 1 && params[:page].to_i > 1 %>
            <% p = params[:page] || 1 %>
            <% if params[:tag] %>
              <a class="prev" href="/tag/<%= "#{params[:tag]}" if params[:tag] %>/<%= p.to_i - 1 %>">Prev</a>
            <% else %>
              <a class="prev" href="/page/<%= p.to_i - 1 %>">Prev</a>
            <% end %>
          <% end %>

          <ul>
            <% @pages.times do |i| %>
              <% if params[:tag] %>
                <li <%= "class='selected'" if ((!params[:page] && i == 0) || (params[:page].to_i - 1) == i) %>><a href="/tag/<%= params[:tag] %>/<%= i + 1 %>"></a></li>
              <% else %>
                <li <%= "class='selected'" if ((!params[:page] && i == 0) || (params[:page].to_i - 1) == i) %>><a href="/page/<%= i + 1 %>"></a></li>
              <% end %>
            <% end %>
          </ul>

          <% if @pages > 1 && (params[:page].to_i < @pages) %>
            <% p = params[:page] || 1 %>
            <% if params[:tag] %>
              <a class="next" href="/tag/<%= "#{params[:tag]}" if params[:tag] %>/<%= p.to_i + 1 %>">Next</a>
            <% else %>
              <a class="next" href="/page/<%= p.to_i + 1 %>">Next</a>
            <% end %>
          <% end %>

        <% end %>
      </div>
        <% end %>

  </div>

</div>
</div>

<script>

  $(function() {

    var options = {
      zoomControl: false,
      cartodb_logo: false,
      scrollwheel: false,
      legends: false,
      time_slider: false
    };

    var urls = <%= raw @visualizations.map {|v| "//#{request.env['HTTP_HOST']}/api/v2/viz/#{v[:id]}/viz.json" }.to_json %>;

    _.each(urls, function(url, i) {
      cartodb.createVis('map_' + i , url, options);
    });

  });
</script>
