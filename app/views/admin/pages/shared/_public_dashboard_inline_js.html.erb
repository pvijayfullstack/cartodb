<script>

  $(function() {

    <% urls = [] %>

    <% @visualizations.map do |v| 
      urls.push(
        :url => "#{ api_v2_visualizations_vizjson_url(user_domain: params[:user_domain], id: v[:id]).sub(/(http:|https:)/i, '') }.json",
        :layer_visibility => v[:layers].map{ |layer| { visible: layer.options["visible"] ? true : false } },
      )
    end %>

    var urls = <%= raw urls.to_json %>;

    _.each(urls, function(url, i) {

      var options = {
        title:          false,
        header:         false,
        description:    false,
        search:         false,
        layer_selector: false,
        text:           false,
        image:          false,
        shareable:      false,
        zoom:           false,
        cartodb_logo:   false,
        scrollwheel:    false,
        legends:        false,
        time_slider:    false,
        loader:         false,
        sublayer_options: url.layer_visibility
      };

      <% if !Rails.env.production? %>
        options.no_cdn = true;
      <% end %>

      cartodb.createVis('map_' + i , url.url, options);
    });

  });

</script>