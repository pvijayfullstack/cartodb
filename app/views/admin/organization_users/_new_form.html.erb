<script type="text/javascript">
  var organization_users = <%= raw current_user.organization.users.map { |u| {
    id: u.id,
    username: u.username,
    quota_in_bytes: u.quota_in_bytes,
    remaining_quota: u.remaining_quota,
    organization_owner: u.organization_owner?
  }}.to_json -%>;
  <% if !@user.new? %>
  var organization_user_data = <%= raw @user.data.to_json.html_safe -%>;
  <% end %>
</script>

<%= form_for @user, url: (@user.new? ? create_organization_user_path(user_domain: params[:user_domain], id: @organization) : update_organization_user_path(user_domain: params[:user_domain], id: @user.username)), :class =>'Form' do |f| %>

  <%= f.hidden_field :private_tables_enabled %>
  <%= hidden_field_tag :show_account_settings_flash, true %>
  <%= csrf_meta_tags %>

  <div class="Form-title">
    <% if !@user.new? %>
      <p class="Form-titleText">Edit or delete <%= @user.username %> user from you <%= current_user.organization.name %> organization.</p>
    <% else %>
      <p class="Form-titleText">Create a new user for your <%= current_user.organization.name %> organization.
      <% if !Cartodb.config[:cartodb_com_hosted].present? %>
        If you need more resources, don't hesitate to <a href="mailto:support@cartodb.com">contact us</a>.
      <% end %>
      </p>
    <% end %>
  </div>

  <div class="Form-row">
    <div class="Form-rowLabel">
      <label class="Form-label">User name</label>
    </div>
    <div class="Form-rowData Form-rowData--med">
      <%= f.text_field :username, :class => "Form-input Form-input--med #{ 'is-disabled' if !@user.new? } #{ 'Form-input--error' if @user.errors[:username].present? }", :readonly => !@user.new? %>
    </div>
    <div class="Form-rowInfo">
      <% if (@user.errors[:username].present?) %>
        <p class="Form-rowInfoText Form-rowInfoText--error">Username not valid</p>
      <% elsif !@user.new? %>
        <p class="Form-rowInfoText">You enter through <%= link_to 'here', @user.public_url %></p>
      <% else %>
        <p class="Form-rowInfoText">Once you choose the username, you won't be able to change it</p>
      <% end %>
    </div>
  </div>

  <div class="Form-row">
    <div class="Form-rowLabel">
      <label class="Form-label">User email</label>
    </div>
    <div class="Form-rowData Form-rowData--med">
      <%= f.text_field :email, :class => "Form-input Form-input--med #{ 'is-disabled' if !@user.can_change_email } #{ 'Form-input--error' if @user.errors[:email].present? }", readonly: !@user.can_change_email %>
    </div>
    <div class="Form-rowInfo">
      <% if (@user.errors[:email].present?) %>
        <p class="Form-rowInfoText Form-rowInfoText--error">Email not valid</p>
      <% elsif @user.new? %>
        <p class="Form-rowInfoText">We encourage you to choose an email from your organization</p>
      <% end %>
    </div>
  </div>

  <div class="Form-row">
    <div class="Form-rowLabel">
      <label class="Form-label">User password</label>
    </div>
    <div class="Form-rowData Form-rowData--med">
      <%= password_field_tag 'user[password]', nil, :placeholder => "new password", :class => "Form-input Form-input--short #{ 'Form-input--error' if @user.errors[:password].present? }" %>
      <%= password_field_tag 'user[password_confirmation]', nil, :placeholder => "confirm new one", :class => "Form-input Form-input--short #{ 'hello' if @user.errors[:password].present?}" %>
    </div>
    <div class="Form-rowInfo">
      <% if (@user.errors[:password].present?) %>
        <p class="Form-rowInfoText Form-rowInfoText--error">Password not valid</p>
      <% else %>
        <p class="Form-rowInfoText">Password should be 6 characters at least</p>
      <% end %>
    </div>
  </div>

  <div class="Form-row">
    <div class="Form-rowLabel">
      <label class="Form-label">User quota</label>
    </div>
    <%= f.hidden_field :quota_in_bytes, :id => "user_quota" %>
    <%= 'ERROR!' if @user.errors[:quota_in_bytes].present? %>
  </div>

  <div class="Form-row">
    <div class="Form-rowLabel">
      <label class="Form-label">Extra geocoding</label>
    </div>
    <div class="Form-rowData">
      <div class="Toggler">
        <%= f.check_box :soft_geocoding_limit, :id => "soft_geocoding_limit" %>
        <%= label_tag(:soft_geocoding_limit, '') %>
      </div>
    </div>
  </div>

  <div class="Form-row">
    <div class="Form-rowLabel">
      <label class="Form-label">Extra tweets</label>
    </div>
    <div class="Form-rowData">
      <div class="Toggler">
        <%= f.check_box :soft_twitter_datasource_limit, :id => "soft_twitter_datasource_limit" %>
        <%= label_tag(:soft_twitter_datasource_limit, '') %>
      </div>
      
    </div>
  </div>

  <div class="Form-footer">
    <% if !@user.new? && current_user.organization_owner? -%>
      <% if @user != current_user %>
        <a href="<%= delete_organization_user_path(user_domain: params[:user_domain], id: @user.username) %>" class="Button Button--negative">
          <span>Delete this user</span>
        </a>
      <% else %>
        <em></em>
      <% end %>
      <button type="submit" class="Button Button--main">
        <span>Save changes</span>
      </button>
    <% else %>
      <em></em>
      <button type="submit" class="Button Button--main">
        <span>Create user</span>
      </button>
    <% end %>
  </div>

<% end %>