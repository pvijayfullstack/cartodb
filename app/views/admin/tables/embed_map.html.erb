<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
    <link rel="shortcut icon" href="/favicons/favicon.ico" />
    <title><%= @table.name %> | CartoDB</title>

    <style type="text/css">
      html, body, #map {height: 100%; padding: 0; margin: 0;}
    </style>

    <%= stylesheet_link_tag :cdb, :media => 'all' %>

    <script id="infowindow_template" type="text/tmpl">
      <div class="cartodb-popup">
        <div class="cartodb-popup-content-wrapper">
          <div class="cartodb-popup-content">
            {{#content.fields}}
            {{#title}}<h4>{{title}}</h4>{{/title}}
            <p>{{value}}</p>{{/content.fields}}
          </div>
        </div>
        <div class="cartodb-popup-tip-container">
        </div>
      </div>
    </script>

    <%= render 'shared/analytics' %>
  </head>
  <body >
    <% if @table.public? %>
    <div id="map"></div>
    <% end %>
  </body>

  <% if @map_provider == 'googlemaps' %>
    <script type="text/javascript" src="https://maps.google.com/maps/api/js?sensor=false"></script>
  <% end %>
  <%= javascript_include_tag :jquery, :cdb %>

  <script>
    var base_layer_tilejson = <%=raw @tilejson_base %>;
    var data_layer_tilejson = <%=raw @layer_data %>;
    data_layer_tilejson.infowindow = <%=raw @layer_data_infowindow %>;
    // those two parameters should be in tilejson
    var table_name = '<%= @table.name %>';
    var table_url = '<%= table_url @table %>';
    var table_description = '<%= @table.description %>';
    var map_provider = '<%= @map_provider %>';

    if(data_layer_tilejson.infowindow) {
      data_layer_tilejson.infowindow.template = $('#infowindow_template').html()
    }

    //base_layer_tilejson.type = 'tilejson';

    function get_url_params() {
      var tokens = location.search.slice(1).split('&');
      var params = {}
      for(var i = 0; i < tokens.length; ++i) {
        var tk = tokens[i].split('=');
        params[tk[0]] = decodeURIComponent(tk[1]);
      }
      return params;
    }

    var opt = get_url_params()
      , overlays = [];

    // Add shareable?
    if (opt.shareable) {
      overlays.push({ type: 'shareable' })
    }

    // Add search?
    if (opt.search) {
      overlays.push({ type: 'search' })
    }

    // Add zoom
    overlays.push({
      type: 'zoom',
      template: '<a class="zoom_in">+</a> <a class="zoom_out">-</a>'
    });



    var vis_data = {
      title: opt.title === 'true' ? table_name:null,
      description: opt.description === 'true' ? table_description: null,
      provider: map_provider,
      overlays: overlays,
      layers: [
        base_layer_tilejson,
        data_layer_tilejson
      ]
    };

    if(opt.title === 'true' || opt.description === 'true') {
      vis_data.overlays.splice(0, 0, { type: 'header' });
    }

    if(opt.sw_lat !== undefined) {
        vis_data.bounds = [
          [opt.sw_lat, opt.sw_lon],
          [opt.ne_lat, opt.ne_lon],
        ];
    }

    if(opt.sql) {
      data_layer_tilejson.query = opt.sql;
    }

    var vis = new cdb.vis.Vis({el: $('#map')});
    vis.load(vis_data);
  </script>
</html>
