<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>CartoDB Platform Documentation 1.0.0 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="None" href="index.html#document-index" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li><a href="index.html#document-index">CartoDB Platform Documentation 1.0.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="welcome-to-cartodb-platform-s-documentation">
<h1>Welcome to CartoDB Platform&#8217;s documentation!<a class="headerlink" href="#welcome-to-cartodb-platform-s-documentation" title="Permalink to this headline">¶</a></h1>
<p>Contents:</p>
<div class="toctree-wrapper compound">
<span id="document-intro"></span><div class="section" id="cartodb-architecture-introduction">
<h2>CartoDB architecture introduction<a class="headerlink" href="#cartodb-architecture-introduction" title="Permalink to this headline">¶</a></h2>
<p>CartoDB is an open source mapping platform composed by several projects. Each project contains one or more components that working together make the mapping platform work.</p>
</div>
<span id="document-components"></span><div class="section" id="components">
<h2>Components<a class="headerlink" href="#components" title="Permalink to this headline">¶</a></h2>
<div class="section" id="versions">
<h3>versions<a class="headerlink" href="#versions" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="id1">
<span id="id2"></span><h3>nginx<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt>Routes all the requests depending on the url to the different services. In general</dt>
<dd><ul class="first last simple">
<li>requests like /api/v1/maps are redirected to <a class="reference internal" href="index.html#maps-api"><em>Maps API</em></a></li>
<li>requests like /api/v1/sql are redirected to <a class="reference internal" href="index.html#sql-api"><em>SQL API</em></a></li>
<li>everything else is redirected to <a class="reference internal" href="index.html#editor"><em>editor</em></a></li>
</ul>
</dd>
</dl>
<p>Some of those are redirected passing through <em class="xref std std-ref">varnish</em></p>
</div>
<div class="section" id="varnish">
<span id="id3"></span><h3>varnish<a class="headerlink" href="#varnish" title="Permalink to this headline">¶</a></h3>
<p>CartoDB uses a custom version of varnish that fixes some race conditions present in varnish 2. See the repo <a class="reference external" href="http://https://github.com/CartoDB/Varnish-Cache/">Varnish</a></p>
</div>
<div class="section" id="redis">
<span id="id5"></span><h3>redis<a class="headerlink" href="#redis" title="Permalink to this headline">¶</a></h3>
<p>A redis instance
TODO: link to the config</p>
</div>
<div class="section" id="editor">
<span id="id6"></span><h3>editor<a class="headerlink" href="#editor" title="Permalink to this headline">¶</a></h3>
<p>CartoDB editor is a rails application and it&#8217;s the component that drivers some of the most important things in cartodb like user management. This is the <a class="reference external" href="https://github.com/cartodb/cartodb">repo</a></p>
<p>Batch component is not a component itself, all the code is in editor repository but it&#8217;s executed running a different command</p>
<p>TODO: config/running</p>
</div>
<div class="section" id="sql-api">
<span id="id7"></span><h3>SQL API<a class="headerlink" href="#sql-api" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="maps-api">
<span id="id8"></span><h3>Maps API<a class="headerlink" href="#maps-api" title="Permalink to this headline">¶</a></h3>
<p>components required:</p>
<blockquote>
<div><ul class="simple">
<li>mapnik</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="postgres">
<span id="id9"></span><h3>Postgres<a class="headerlink" href="#postgres" title="Permalink to this headline">¶</a></h3>
<p>Database component is basically a Postgres 9.3 instance running. CartoDB needs administration permissions since the editor needs to create new databases and users.</p>
<p>components required:</p>
<blockquote>
<div><ul class="simple">
<li>pgbouncer</li>
<li>cartodb-postgres</li>
<li>cartodb postgis branch</li>
</ul>
</div></blockquote>
<p>TODO: link to the configuration</p>
</div>
<div class="section" id="workers">
<h3>Workers<a class="headerlink" href="#workers" title="Permalink to this headline">¶</a></h3>
<p>workers are based on resque and uses the same editor code</p>
</div>
</div>
<span id="document-deploy"></span><div class="section" id="deploy">
<h2>Deploy<a class="headerlink" href="#deploy" title="Permalink to this headline">¶</a></h2>
<p>There are two deployment options for CartoDB:</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference internal" href="#id1">single instance</a> where everything runs in the same machine.</li>
<li><a class="reference internal" href="#distributed">distributed</a>, every component runs in its on machine</li>
</ul>
</div></blockquote>
<img alt="_images/overview_architecture.png" src="_images/overview_architecture.png" />
<div class="section" id="single-instance">
<span id="id1"></span><h3>single instance<a class="headerlink" href="#single-instance" title="Permalink to this headline">¶</a></h3>
<p>Single machine instance installation it&#8217;s useful for simple installations where scalability is not the key.</p>
<p>In this case all the components run as processes:</p>
<blockquote>
<div><ul class="simple">
<li>1 postgres + pgbouncer</li>
<li>1 nginx</li>
<li>1 varnish</li>
<li>N editor</li>
<li>1 batch machines (same editor code)</li>
<li>1 SQL API</li>
<li>1 Maps PI</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="distributed">
<span id="id2"></span><h3>distributed<a class="headerlink" href="#distributed" title="Permalink to this headline">¶</a></h3>
<p>Distributed installation is meant for enviorments where scalability and performanc are important, the setup is more complex since each component requires 1 or more machines</p>
<blockquote>
<div><ul class="simple">
<li>1 postgres + pgbouncer</li>
<li>1 nginx</li>
<li>1 varnish</li>
<li>N editor</li>
<li>1 batch machines (same editor code)</li>
<li>1 SQL API</li>
<li>1 Maps PI</li>
</ul>
</div></blockquote>
</div>
</div>
<span id="document-scalability"></span><div class="section" id="scalability">
<h2>Scalability<a class="headerlink" href="#scalability" title="Permalink to this headline">¶</a></h2>
<p>Scalability in CartoDB depends a lot on the kind of data and applications using it, it&#8217;s hard to do good setup valid of all the scenarios.</p>
<dl class="docutils">
<dt>The worst case scenarios are the ones with:</dt>
<dd><ul class="first last simple">
<li>lot of data</li>
<li>frequent updates</li>
<li>applications running complex queries</li>
<li>applications with high number of layers</li>
</ul>
</dd>
</dl>
<div class="section" id="some-examples">
<h3>Some examples<a class="headerlink" href="#some-examples" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ul class="simple">
<li>Case 1: Openstreetmap is a good example of lot of data and frequent updates but the queries are not really complex (just a dump of data)</li>
<li>Case 2: a map that shows the number of sales per district can have very few data but the query to count the number of points inside each polygon is complex</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="vertical-scalability">
<h3>Vertical scalability<a class="headerlink" href="#vertical-scalability" title="Permalink to this headline">¶</a></h3>
<p>When running CartoDB as a <a class="reference internal" href="index.html#single-instance"><em>single instance</em></a> multiple changes can be done in order to archieve more performance:</p>
<blockquote>
<div><ul>
<li><dl class="first docutils">
<dt>CPU number: there are many things in CartoDB that are CPU bound:</dt>
<dd><ul class="first simple">
<li>windshaft: rendering tiles is an expensive operation</li>
<li>postgres: depending on the SQL query it could use a lot of CPU (+ disk IO)</li>
</ul>
<p class="last">Depending on the application usage it may need to use more CPU&#8217;s for rendering (Case 1) or for postgres (Case 2)</p>
</dd>
</dl>
</li>
<li><p class="first">disk: main IO bottleneck is in postgres so having an SSD disk will improve the performance.</p>
</li>
<li><p class="first">memory: postgres and editor workers are the process that require more memory so if the machine is going to be used for a editing makes sense to memory.</p>
</li>
</ul>
</div></blockquote>
<p>Configuration options:</p>
<ul>
<li><dl class="first docutils">
<dt>Postgres:</dt>
<dd><ul class="first simple">
<li>shared memory (so all the indices are in memory)</li>
<li>cluster tables regurarly by the_geom_webmercator index</li>
</ul>
<p class="last">//TODO: alejandro</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Windshaft:</dt>
<dd><ul class="first simple">
<li>number of mapnik workers. As many workers, less latency but more memory usage. <tt class="docutils literal"><span class="pre">uv_threadpool_size</span></tt> and <tt class="docutils literal"><span class="pre">renderer.mapnik.poolSize</span></tt> are the variables needed.</li>
</ul>
<p class="last">//TODO: rochoa</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Importer</dt>
<dd><ul class="first last simple">
<li>if the number of imports is high, number of resque workers should be increased. It may also need to provide more memory for database since part of the import is processed by postgres</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Rails app:</dt>
<dd><ul class="first simple">
<li>the bottleneck for <cite>editor</cite> processes is memory so if the machine is going to be used for editing a reasonable number of editor workers is 8 (around 300mb per instance)</li>
</ul>
<p class="last">//TODO: kartones</p>
</dd>
</dl>
</li>
</ul>
</div>
<div class="section" id="horizontal-scalability">
<h3>Horizontal scalability<a class="headerlink" href="#horizontal-scalability" title="Permalink to this headline">¶</a></h3>
<p>All the concepts from vertical scalability apply here, the recommended setup is to have as many machines as needed depending on the load for editor, import workers and windshaft. SQL API could be run in the same machine than windshaft.</p>
</div>
</div>
<span id="document-monitoring"></span><div class="section" id="monitoring">
<h2>Monitoring<a class="headerlink" href="#monitoring" title="Permalink to this headline">¶</a></h2>
<div class="section" id="servers-monitor">
<h3>servers monitor<a class="headerlink" href="#servers-monitor" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ul class="simple">
<li>nagios</li>
<li>ganglia</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="app-health-checks">
<h3>app health checks<a class="headerlink" href="#app-health-checks" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ul class="simple">
<li>varnish</li>
<li>nginx</li>
<li>windshaft</li>
<li>sql api</li>
<li>rails</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="application-monitoring">
<h3>application monitoring<a class="headerlink" href="#application-monitoring" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ul class="simple">
<li>elasticsearch + kibana</li>
<li>statsd + graphite</li>
</ul>
</div></blockquote>
</div>
</div>
</div>
</div>
<div class="section" id="indices-and-tables">
<h1>Indices and tables<a class="headerlink" href="#indices-and-tables" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><a class="reference internal" href="genindex.html"><em>Index</em></a></li>
<li><a class="reference internal" href="py-modindex.html"><em>Module Index</em></a></li>
<li><a class="reference internal" href="search.html"><em>Search Page</em></a></li>
</ul>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html#document-index">Table Of Contents</a></h3>
  <ul>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-intro">CartoDB architecture introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-components">Components</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#versions">versions</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id1">nginx</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#varnish">varnish</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#redis">redis</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#editor">editor</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#sql-api">SQL API</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#maps-api">Maps API</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#postgres">Postgres</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#workers">Workers</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-deploy">Deploy</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#single-instance">single instance</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#distributed">distributed</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-scalability">Scalability</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#some-examples">Some examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#vertical-scalability">Vertical scalability</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#horizontal-scalability">Horizontal scalability</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-monitoring">Monitoring</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#servers-monitor">servers monitor</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#app-health-checks">app health checks</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#application-monitoring">application monitoring</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li><a href="index.html#document-index">CartoDB Platform Documentation 1.0.0 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2015, Javi Santana.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>