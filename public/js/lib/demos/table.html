<!DOCTYPE html>
<html>
  <head>
    <title>cartodb demo template</title>
  </head>

  <style>
    body {
      background-color: #FFF;
    }
    td {
      border: 1px solid #333;
    }
  </style>


  <body>
    <h1>table</h1>
    <p>use console to modify cols variable, i.e:</p>
    <pre>
      cols.add({'id': 10, 'col1': 1, 'col2': 2, 'col3': 3});
      cols.at(0).destroy()
    </pre>
  </body>

  <script src="../cdb.js/src/cartodb.js"></script>
  <script>
    window.onload = function() {
      cdb.load('../cdb.js/src/', function() {
      var getValue = function(object, prop) {
          if (!(object && object[prop])) return null;
          return _.isFunction(object[prop]) ? object[prop]() : object[prop];
        };
        

        var CartoDBTableData = cdb.ui.common.TableData.extend({

          initialize: function(models, options) {
            this.table = options.table;
            this.model.prototype.idAttribute = 'cartodb_id';
          },

          parse: function(d) {
            return d.rows;
          },

          url: function() {
            //return 'http://' +location.hostname + ':8080/api/v1/sql';
            return '/api/v1/tables/' + this.table + '/records';
          },
          _sync: function(method, model, options) {
            // Default options, unless specified.
            options || (options = {});

            // Default JSON-request options.
            var params = { dataType: 'json'};

            // Ensure that we have a URL.
            if (!options.url) {
              params.url = getValue(model, 'url') || urlError();
            }

            if(method === 'read') {
              params.url += '?q=' + encodeURIComponent('SELECT * from "' + this.table + '" limit 10');
              //params.url += '&format=geojson'
              params.type = 'GET';
            }
            // Make the request, allowing the user to override any Ajax options.
            return $.ajax(_.extend(params, options));
            /*
            'create': 'POST',
    'update': 'PUT',
    'delete': 'DELETE',
    'read':   'GET'
            var type = methodMap[method];


            // Ensure that we have the appropriate request data.
            if (!options.data && model && (method == 'create' || method == 'update')) {
              params.contentType = 'application/json';
              params.data = JSON.stringify(model);
            }

            // For older servers, emulate JSON by encoding the request into an HTML-form.
            if (Backbone.emulateJSON) {
              params.contentType = 'application/x-www-form-urlencoded';
              params.data = params.data ? {model: params.data} : {};
            }

            // For older servers, emulate HTTP by mimicking the HTTP method with `_method`
            // And an `X-HTTP-Method-Override` header.
            if (Backbone.emulateHTTP) {
              if (type === 'PUT' || type === 'DELETE') {
                if (Backbone.emulateJSON) params.data._method = type;
                params.type = 'POST';
                params.beforeSend = function(xhr) {
                  xhr.setRequestHeader('X-HTTP-Method-Override', type);
                };
              }
            }

            // Don't process data on a non-GET request.
            if (params.type !== 'GET' && !Backbone.emulateJSON) {
              params.processData = false;
            }
            */

          }
        });

        //cols = new CartoDBTableData(null, { table: 'tm_world_borders-0' });
        cols = new CartoDBTableData(null, { table: 'borders' });

        tableMetadata = new cdb.ui.common.TableProperties();
        tableMetadata.url = function() {
          return '/api/v1/tables/' + this.name;
        }
        window.meta = tableMetadata;
        window.cols = cols;



        table = new cdb.ui.common.Table({
          dataModel: cols,
          model: tableMetadata
        });

        $('body').append(table.render().el);
        cols.fetch();
        tableMetadata.fetch();
      });
    };
  </script>
</html>
